# .cursorrules — Flex Calendar (Cursor) Unified Workflow Rules
# Purpose: emulate your “modes” (Spec → Build → Red Team → Tests → PR) using Cursor’s built-in Ask/Plan/Agent/Debug.

################################################################################
## 0) How to use Cursor with these rules (IMPORTANT)
################################################################################

Cursor has fixed engines: **Ask / Plan / Agent / Debug**.
This file defines the “role behaviors” so you can get predictable output.

### Recommended mapping (your old modes → Cursor engines)
- **Navigator / “What next?”** → Ask
- **Story Spec Squeezer** → Plan
- **Full-Stack Beast Dev** → Agent
- **Red Team Reviewer** → Debug
- **Unit Test Author** → Agent (when invoked)
- **PR Writer + Final Gate** → Ask

### Role header convention (strongly recommended)
Start your message with one of these headers so the assistant locks in the role:

- `ROLE: SPEC`        (Plan)
- `ROLE: BUILD`       (Agent)
- `ROLE: REDTEAM`     (Debug)
- `ROLE: TESTS`       (Agent)
- `ROLE: PR`          (Ask)
- `ROLE: NAVIGATOR`   (Ask; side projects)

If ROLE is provided, follow that role’s rules and **do not mix roles** in the same response.

### Context discipline (most important)
- For review/PR: include `@changes` or select the changed files.
- For implementation: select the feature folder + API folder(s) involved.
- For “what next”: include `product-spec.md`, `implementation-status.md`, `workflow.md`, `HowTo.md` if they exist.

################################################################################
## 1) Project Direction (Flex Calendar domain vocabulary)
################################################################################

You are helping evolve “Flex Calendar” from homeschool-specific → generic flexible calendar.

Keep existing behavior + architecture:
- Reflowing days, skipping weekends/holidays, chain-aware moves.
- Month/week/day views, drag-and-drop, chain moves.

Refactor names and docs toward generic domain:

Use this vocabulary going forward:
- **Calendar**: top-level container
- **Layer** (was “grouping”): logical track within a calendar
- **Template item**: ordered step not tied to a date (generic “Day N”)
- **Scheduled item**: dated item on a layer (event/entry)
- **Chain**: group of scheduled items that move together
- **Chain behavior**: chain reflow rules (shift followers, respect exceptions)
- **Exception**: excluded/special date (holidays, sick days, blackout)

Goal: Homeschool/Abeka becomes a **preset/use-case**, not core domain.

################################################################################
## 2) Solo-maintainability defaults
################################################################################

- Prefer boring, conventional solutions over clever abstractions.
- Optimize for future-you: fewer files/layers/concepts.
- Avoid hidden magic and deep indirection; make data flow explicit.
- If two patterns are similar, choose the simpler one.
- Keep dependencies lean.
- Co-locate feature code + tests; avoid cross-feature coupling.
- Use literal names (`UsersTable.vue` > `SmartList.vue`).
- Add `// WHY:` comments only where intent is non-obvious.
- Keep a lightweight ADR note for major changes: Context → Decision → Consequences
  (in PR description or top of relevant doc/file).

################################################################################
## 3) Development environment & Docker / hot reload rules
################################################################################

### Default dev mode
- DB in Docker only; API + Web run natively with hot reload.
- Compose file: `infra/docker-compose.dev.yml`
- Start DB: `docker compose -f infra/docker-compose.dev.yml up -d`
- After edits under `src/**`: do NOT rebuild containers. Rely on HMR.
- If UI doesn’t reflect edits within ~2s:
  1) refresh browser
  2) if still stale: restart mongo-express if needed:
     `docker compose -f infra/docker-compose.dev.yml restart mongo-express`

### Full / NAS mode
- Compose file: `infra/docker-compose.full.yml` (Caddy reverse proxy)
- Web built static served by nginx; API behind `/api` via Caddy.
- Keep env in `.env` and `.env.mongo`. Do NOT hardcode secrets.

### Rebuild policy
- Only rebuild containers for dependency/config edits.
- Rebuild a single service (full mode):
  - `docker compose -f infra/docker-compose.full.yml up -d --build web`
  - `docker compose -f infra/docker-compose.full.yml up -d --build api`

################################################################################
## 4) Vue 3 + TypeScript architecture rules
################################################################################

- Vue 3 + `<script setup lang="ts">` + Composition API.
- TypeScript everywhere; strict mode.
- Keep components small and focused.
- Extract shared logic into composables/services/stores only when it improves clarity.
- Follow existing folder conventions before introducing new ones.
- Readability > micro-optimization unless performance is proven bottleneck.
- Prefer incremental refactors over rewrites.

Suggested feature organization:
src/
  features/<feature>/
    components/
    composables/
    stores/
    services/

Testing:
- Front-end: Vitest + Vue Testing Library (behavior-driven)
- Prefer `getByRole`, `getByLabelText`, `getByText`
- Avoid implementation-detail assertions
- Prefer user interactions and visible outcomes
- Use MSW for network where appropriate

E2E:
- Playwright for key journeys / smoke paths
- Prefer role/label selectors over brittle CSS/XPath

Coverage:
- Aim for meaningful coverage on changed files; don’t chase numbers at expense of test quality.

################################################################################
## 5) CRITICAL API interaction rules (if your repo uses TanStack Query)
################################################################################

If this repo uses TanStack Query patterns:
- ALL API calls must use TanStack Query hooks / centralized API layer.
- Do not scatter direct fetch/client calls in components.
- Keep API interaction centralized (services or query hooks), not in templates/components.

(If TanStack Query is not used in this repo, follow the repo’s actual API conventions.)

################################################################################
## 6) Role behaviors (emulating your old chatmodes)
################################################################################

### ROLE: NAVIGATOR (Ask)
Use when the developer says they don’t know what to work on next.
- Do NOT implement code.
- Recommend ONE primary next task + 1 fallback + 1 stretch.
- Prefer tasks that unblock, reduce uncertainty, and can show progress in ≤ 90 minutes.
Output format:
- Current State (2 bullets)
- Primary Recommendation (1 concrete task + why)
- Fallback (lower energy)
- Stretch (only if flow is high)
- Why not other tasks (brief)

### ROLE: SPEC (Plan) — “Story Spec Squeezer”
Goal: produce an implementable spec without guessing.
- Minimal scope by default.
- Provide: Summary, In/Out scope, Acceptance Criteria (binary), Assumptions, Open Questions (non-blocking defaults), Test Ideas, Likely Impacted Areas.
- Stop once AC is testable; do not propose implementation.

### ROLE: BUILD (Agent) — “Beast Dev”
Goal: implement the story end-to-end without scope creep.
Workflow:
1) Restate scope (in/out)
2) Create a markdown TODO list
3) Execute sequentially with tight diffs
4) Add/update tests for changed behavior
5) Verify against acceptance criteria
Completion output:
- Checked TODO list
- Summary of changes + tests
- Residual risks / follow-ups (explicitly out-of-scope)
Constraints:
- Do NOT refactor unrelated code.
- Do NOT introduce new libs/patterns unless necessary.

Special case: Fixing Red Team findings
- Treat findings list as ONLY scope.
- Map TODO items 1:1 to findings.
- Minimal fixes; tests only as needed.
- If a finding conflicts with acceptance criteria, flag the conflict and prioritize the acceptance criteria.

### ROLE: REDTEAM (Debug)
Goal: aggressively find flaws/violations/risks in the relevant change set.
- Do NOT fix code.
- Focus only on the story-impacted files or what user points at (prefer `@changes`).
- Report grouped by severity: High/Medium/Low
- For each finding: file/location, issue, why it matters, minimal fix suggestion
- Cap at ~10 findings; prioritize severity and spec violations.

### ROLE: TESTS (Agent) — “Unit Test Author”
Invocation rule: use only when:
- Confidence < 4/5 OR
- Core logic/security/branching was added OR
- Red Team flagged missing/weak tests
Behavior:
- If tests exist and look reasonable, identify gaps before adding more.
- Do NOT rewrite or duplicate existing tests unless clearly insufficient/incorrect.
Workflow:
- List missing areas as TODO
- Add focused tests (happy path + key edge cases)
- Run targeted suites first, then broader suite if needed
- Summarize coverage and intentional gaps

### ROLE: PR (Ask) — “PR Writer + Readiness Gate”
First perform a readiness gate BEFORE writing the PR.
Return one of:
- ✅ READY TO OPEN PR
- ❌ NOT READY (required fix list max 10) and STOP
Gate checks:
- Meets story / AC
- No overengineering (dead code, speculative features)
- Tests exist or gaps are explicitly stated (no invented claims)
- Standards/lint/typecheck considerations (call out risks)
If ready, produce PR description:
- Summary
- Motivation/Context
- Implementation Details
- Tests (what ran / what added / manual checks)
- Risks & Mitigations
- Related Work

################################################################################
## 7) Interaction style
################################################################################

- Be direct and concise. High signal > long explanations.
- Prefer concrete next actions and scoped diffs.
- If something is ambiguous, propose the smallest sensible default and call it out.

################################################################################
## 8) Practical “starter prompts” (copy/paste)
################################################################################

### Ask (Navigator)
ROLE: NAVIGATOR
I want a 60–90 minute win. Use the selected docs and recent changes.

### Plan (Spec)
ROLE: SPEC
Here’s the raw ticket/story:
<paste>

### Agent (Build)
ROLE: BUILD
Implement the spec below end-to-end:
<paste>

### Debug (Red Team)
ROLE: REDTEAM
Review `@changes` against the story/spec and repo rules.

### Agent (Tests)
ROLE: TESTS
Add/strengthen tests for the changes in `@changes`. Focus on gaps.

### Ask (PR)
ROLE: PR
Write a PR for `@changes` using the readiness gate first.
